<!doctype html>
<html lang="pa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡®Æ‡©Å‡®π‡®æ‡®µ‡®∞‡®æ ‡®Æ‡®æ‡®π‡®ø‡®∞ ‚Äî Full Game</title>

  <style>
    :root{
      --bg1:#e3f2fd; --bg2:#ffffff;
      --card:#ffffff; --ink:#0b1b2a;
      --primary:#0d47a1; --primary2:#1565c0;
      --good:#1b5e20; --bad:#b71c1c;
      --soft:#eef6ff; --soft2:#f7fbff;
      --shadow:0 10px 28px rgba(0,0,0,.16);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Noto Sans Gurmukhi", system-ui, Arial;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--ink); text-align:center;
    }
    header{padding:18px 12px 8px}
    h1{margin:0; font-size:26px; color:var(--primary)}
    .sub{margin:6px 0 0; opacity:.82; font-size:13px; line-height:1.35}
    .wrap{max-width:1100px; margin:0 auto; padding:12px}

    .panel{
      background:var(--card); border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px; margin:12px 0;
    }

    .topbar{
      display:flex; flex-wrap:wrap; gap:10px;
      justify-content:space-between; align-items:center;
      margin:8px 0 14px;
    }
    .chip{
      background:var(--soft);
      padding:10px 12px; border-radius:999px;
      box-shadow:0 6px 16px rgba(0,0,0,.08);
      font-size:14px; display:flex; gap:10px; align-items:center;
      justify-content:center; flex-wrap:wrap;
    }

    .btnrow{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    button{
      border:0; border-radius:14px; padding:10px 14px;
      background:var(--primary); color:#fff; cursor:pointer;
      font-size:15px; box-shadow:0 8px 18px rgba(13,71,161,.25);
    }
    button:hover{background:var(--primary2)}
    button.secondary{background:#223; opacity:.92; box-shadow:0 8px 18px rgba(0,0,0,.18);}
    button.ghost{background:#fff; color:var(--primary); border:2px solid var(--primary); box-shadow:none;}

    /* Level 1 MCQ */
    .qbox{padding:8px 10px}
    .qtitle{font-size:22px; margin:10px 0 10px}
    .hint{font-size:13px; opacity:.75; margin:-4px 0 10px}
    .grid2{display:grid; grid-template-columns:1fr; gap:10px}
    @media(min-width:720px){ .grid2{grid-template-columns:1fr 1fr;} }
    .opt{
      background:var(--soft2);
      border:2px solid transparent;
      border-radius:16px;
      padding:14px 12px;
      cursor:pointer; text-align:left;
      font-size:17px;
      transition:.12s transform ease,.12s border-color ease,.12s background ease;
      box-shadow:0 6px 16px rgba(0,0,0,.07);
    }
    .opt:hover{transform:translateY(-1px); border-color:#cfe6ff}
    .opt.good{border-color:rgba(27,94,32,.5); background:#e8f5e9}
    .opt.bad{border-color:rgba(183,28,28,.5); background:#ffebee}

    /* ===================== Level 2 Drag & Drop (COMPACT + COLORFUL) ===================== */
    .dd-wrap{
      display:grid; grid-template-columns:1fr; gap:12px;
      max-height:68vh;              /* ‚úÖ no long page */
      overflow:hidden;
    }
    @media(min-width:900px){ .dd-wrap{grid-template-columns:1fr 1fr;} }

    .dd-col{
      border-radius:18px; padding:12px;
      box-shadow:0 8px 20px rgba(0,0,0,.08);
      max-height:68vh;              /* ‚úÖ internal scroll */
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      border:2px solid rgba(13,71,161,.12);
      background:linear-gradient(135deg, rgba(255,255,255,.92), rgba(227,242,253,.92));
    }
    .dd-title{margin:4px 0 10px; color:var(--primary)}

    .pill{
      border-radius:999px;
      padding:10px 12px;
      margin:10px 0;
      cursor:grab;
      user-select:none; -webkit-user-select:none;
      touch-action:none;
      position:relative;
      text-align:left;
      font-size:15px;
      font-weight:900;
      box-shadow:0 8px 18px rgba(0,0,0,.10);
      border:2px solid rgba(13,71,161,.14);
      background:linear-gradient(135deg,#ffffff,#f7fbff);
    }
    .pill:active{cursor:grabbing}
    .pill:nth-child(6n+1){ background: linear-gradient(135deg,#ffebee,#ffffff); }
    .pill:nth-child(6n+2){ background: linear-gradient(135deg,#e8f5e9,#ffffff); }
    .pill:nth-child(6n+3){ background: linear-gradient(135deg,#e3f2fd,#ffffff); }
    .pill:nth-child(6n+4){ background: linear-gradient(135deg,#fff3e0,#ffffff); }
    .pill:nth-child(6n+5){ background: linear-gradient(135deg,#f3e5f5,#ffffff); }
    .pill:nth-child(6n+0){ background: linear-gradient(135deg,#e0f7fa,#ffffff); }

    .drop{
      border-radius:16px;
      padding:10px;
      margin:10px 0;
      text-align:left;
      min-height:66px;
      display:flex; align-items:flex-start; gap:10px;
      touch-action:none; -webkit-user-select:none;
      position:relative;
      border:2px dashed rgba(13,71,161,.35);
      background:linear-gradient(135deg,#ffffff,#f2f7ff);
      box-shadow:0 8px 18px rgba(0,0,0,.08);
    }
    .drop strong{color:#223}
    .drop .mini{font-size:12px; opacity:.75; margin-top:2px}
    .drop.correctPair{display:none;} /* ‚úÖ vanish on correct */
    .drop.flashBad{ animation: shake .25s; border-color: rgba(183,28,28,.65); }
    .drop.flashOk{ border-style:solid; border-color: rgba(27,94,32,.55); }

    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      50%{transform:translateX(6px)}
      75%{transform:translateX(-6px)}
      100%{transform:translateX(0)}
    }

    /* Level 3 Bubble */
    .bubbleWrap{
      background:linear-gradient(135deg,#ffffff,#f1f8ff);
      border-radius:22px; padding:12px;
      box-shadow:0 10px 26px rgba(0,0,0,.12);
      position:relative; overflow:hidden;
      height:580px;
    }
    .bubbleHeader{
      display:flex; flex-wrap:wrap; gap:10px;
      justify-content:space-between; align-items:center;
      padding:6px 6px 10px;
    }
    .target{
      background:#fff; border:2px solid #d8ecff;
      border-radius:16px; padding:10px 12px;
      text-align:left; box-shadow:0 6px 16px rgba(0,0,0,.06);
      flex:1; min-width:260px;
    }
    .timerBox{
      background:#fff; border:2px solid #d8ecff;
      border-radius:16px; padding:10px 12px;
      min-width:240px;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
      text-align:left;
    }
    .playfield{
      position:absolute;
      left:10px; right:10px; top:128px; bottom:10px;
      border-radius:18px;
      background:radial-gradient(circle at 20% 20%, #e3f2fd, #ffffff);
      border:2px solid #d8ecff;
      overflow:hidden;
      touch-action: manipulation;
    }
    .bubble{
      position:absolute;
      width:160px; height:160px;
      border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      padding:12px;
      font-size:14px;
      font-weight:900;
      color:#0b1b2a;
      cursor:pointer;
      user-select:none;
      box-shadow:0 14px 28px rgba(0,0,0,.16);
      border:2px solid rgba(13,71,161,.15);
      transition:transform .12s;
      will-change:left, top, transform;
      line-height:1.2;
    }
    .bubble:active{ transform:scale(0.98); }
    .pop{ animation: pop .16s ease forwards; }
    @keyframes pop{ to{ transform:scale(1.22); opacity:0; } }

    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background:#111; color:#fff;
      padding:10px 14px; border-radius:999px;
      opacity:0; pointer-events:none;
      transition:.18s opacity ease, .18s transform ease;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
      font-size:14px;
      z-index:999;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
  </style>
</head>

<body>
<header>
  <h1>üéÆ ‡®Æ‡©Å‡®π‡®æ‡®µ‡®∞‡®æ ‡®Æ‡®æ‡®π‡®ø‡®∞</h1>
  <div class="sub">
    Level 1 (MCQ) ‚Ä¢ Level 2 (Drag & Drop iPhone ‚úÖ, correct pair vanish ‚úÖ, compact ‚úÖ, colorful ‚úÖ) ‚Ä¢ Level 3 (Bubble)
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <div class="topbar">
      <div class="chip">üèÅ ‡®≤‡©à‡®µ‡®≤: <b id="lvlName">‚Äî</b></div>
      <div class="chip">‚≠ê ‡®∏‡®ï‡©ã‡®∞: <b id="score">0</b></div>
      <div class="chip">
        üîä Sound: <b id="soundState">ON</b>
        <button class="ghost" style="padding:6px 10px;border-radius:12px" onclick="toggleSound()">ON/OFF</button>
        <button class="ghost" style="padding:6px 10px;border-radius:12px" onclick="unlockAudio()">Start/Test</button>
      </div>
    </div>

    <div class="btnrow">
      <button onclick="startLevel(1)">Level 1 (MCQ)</button>
      <button onclick="startLevel(2)">Level 2 (Drag & Drop)</button>
      <button onclick="startLevel(3)">Level 3 (Bubble)</button>
      <button class="ghost" onclick="resetAll()">Reset</button>
    </div>

    <div id="stage" class="qbox"></div>

    <div class="btnrow" style="margin-top:14px">
      <button class="secondary" onclick="goMenu()">üè† Menu</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===================== SOUND (WebAudio) ===================== */
let SOUND_ON = true;
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === "suspended") audioCtx.resume();
}
function beep(freq=440, duration=0.10, type="sine", gain=0.10){
  if(!SOUND_ON) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = gain;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime + duration);
}
function playClick(){ beep(520, 0.05, "square", 0.06); }
function playPop(){ beep(760, 0.06, "triangle", 0.08); }
function playCorrect(){ beep(660, 0.08, "sine", 0.12); setTimeout(()=>beep(880, 0.10, "sine", 0.12), 90); }
function playWrong(){ beep(220, 0.14, "sawtooth", 0.10); }
function playWin(){ [523,659,784,988].forEach((f,i)=>setTimeout(()=>beep(f, 0.10, "sine", 0.12), i*110)); }
function toggleSound(){
  playClick();
  SOUND_ON = !SOUND_ON;
  document.getElementById("soundState").textContent = SOUND_ON ? "ON" : "OFF";
  toast(SOUND_ON ? "Sound ON üîä" : "Sound OFF üîá");
}
function unlockAudio(){
  ensureAudio();
  playClick();
  setTimeout(()=>playCorrect(), 120);
  toast("Sound Ready ‚úÖ");
}

/* ===================== Utilities ===================== */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function el(id){ return document.getElementById(id); }
function toast(msg){
  const t = el('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 1100);
}
function escapeHtml(str){
  return str.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function rand(min,max){ return Math.random()*(max-min)+min; }

/* ===================== DATA ===================== */
const L1 = [
  { idiom:"‡®Ö‡©±‡®ñ‡®æ‡®Ç ‡®µ‡®ø‡©±‡®ö ‡®ß‡©Ç‡©ú ‡®™‡®æ‡®â‡®£‡®æ", q:"'‡®Ö‡©±‡®ñ‡®æ‡®Ç ‡®µ‡®ø‡©±‡®ö ‡®ß‡©Ç‡©ú ‡®™‡®æ‡®â‡®£‡®æ' ‡®¶‡®æ ‡®Ö‡®∞‡®• ‡®ï‡©Ä ‡®π‡©à?", opts:["‡®ß‡©ã‡®ñ‡®æ ‡®¶‡©á‡®£‡®æ","‡®Æ‡®¶‡®¶ ‡®ï‡®∞‡®®‡®æ","‡®∏‡©±‡®ö ‡®¨‡©ã‡®≤‡®£‡®æ","‡®°‡®∞ ‡®ú‡®æ‡®£‡®æ"], ans:0 },
  { idiom:"‡®®‡©±‡®ï ‡®ï‡©±‡®ü‡®£‡®æ", q:"'‡®®‡©±‡®ï ‡®ï‡©±‡®ü‡®£‡®æ' ‡®¶‡®æ ‡®ï‡©Ä ‡®Ö‡®∞‡®• ‡®π‡©à?", opts:["‡®á‡©±‡®ú‡®º‡®§ ‡®ò‡®ü‡®æ‡®â‡®£‡®æ","‡®∏‡®Æ‡®ù‡®æ‡®â‡®£‡®æ","‡®π‡©±‡®∏‡®£‡®æ","‡®Æ‡®æ‡®´‡®º ‡®ï‡®∞‡®®‡®æ"], ans:0 },
  { idiom:"‡®™‡®æ‡®£‡©Ä ‡®´‡®ø‡®∞ ‡®ú‡®æ‡®£‡®æ", q:"'‡®™‡®æ‡®£‡©Ä ‡®´‡®ø‡®∞ ‡®ú‡®æ‡®£‡®æ' ‡®¶‡®æ ‡®Æ‡®§‡®≤‡®¨?", opts:["‡®Ø‡©ã‡®ú‡®®‡®æ ‡®´‡©á‡®≤ ‡®π‡©ã ‡®ú‡®æ‡®£‡®æ","‡®®‡®π‡®æ‡®â‡®£‡®æ","‡®ñ‡®æ‡®£‡®æ ‡®ñ‡®æ‡®£‡®æ","‡®ñ‡©Å‡®∏‡®º ‡®π‡©ã‡®£‡®æ"], ans:0 },
  { idiom:"‡®ï‡©∞‡®® ‡®ñ‡©ú‡©á ‡®π‡©ã‡®£‡®æ", q:"'‡®ï‡©∞‡®® ‡®ñ‡©ú‡©á ‡®π‡©ã‡®£‡®æ' ‡®¶‡®æ ‡®Ö‡®∞‡®•?", opts:["‡®∏‡®æ‡®µ‡®ß‡®æ‡®® ‡®π‡©ã ‡®ú‡®æ‡®£‡®æ","‡®∏‡©å‡®£‡®æ","‡®∞‡©ã‡®£‡®æ","‡®ó‡©Å‡©±‡®∏‡®æ ‡®ï‡®∞‡®®‡®æ"], ans:0 },
  { idiom:"‡®Æ‡©Ç‡©∞‡®π ‡®¶‡©Ä ‡®ñ‡®æ‡®£‡®æ", q:"'‡®Æ‡©Ç‡©∞‡®π ‡®¶‡©Ä ‡®ñ‡®æ‡®£‡®æ' ‡®¶‡®æ ‡®Ö‡®∞‡®•?", opts:["‡®π‡®æ‡®∞ ‡®ú‡®æ‡®£‡®æ","‡®≠‡©Å‡©±‡®ñ ‡®≤‡©±‡®ó‡®£‡®æ","‡®¨‡©ã‡®≤‡®£‡®æ","‡®ú‡®ø‡©±‡®§ ‡®ú‡®æ‡®£‡®æ"], ans:0 }
];

const L2_PAIRS = [
  { idiom:"‡®¶‡®ø‡®≤ ‡®§‡©á ‡®≤‡©à‡®£‡®æ", meaning:"‡®ó‡©±‡®≤ ‡®®‡©Ç‡©∞ ‡®¨‡®π‡©Å‡®§ ‡®ó‡©∞‡®≠‡©Ä‡®∞‡®§‡®æ ‡®®‡®æ‡®≤ ‡®≤‡©à ‡®≤‡©à‡®£‡®æ" },
  { idiom:"‡®π‡©±‡®• ‡®ñ‡©ú‡©á ‡®ï‡®∞ ‡®¶‡©á‡®£‡®æ", meaning:"‡®π‡®æ‡®∞ ‡®Æ‡©∞‡®® ‡®≤‡©à‡®£‡®æ / ‡®Ö‡®∏‡®Æ‡®∞‡©±‡®• ‡®π‡©ã ‡®ú‡®æ‡®£‡®æ" },
  { idiom:"‡®ö‡®™‡©á‡©ú‡®æ‡®Ç ‡®ñ‡®æ‡®£‡©Ä‡®Ü‡®Ç", meaning:"‡®Æ‡©Å‡®∏‡©Ä‡®¨‡®§‡®æ‡®Ç ‡®ù‡©±‡®≤‡®£‡©Ä‡®Ü‡®Ç" },
  { idiom:"‡®ö‡®ø‡©±‡®ü‡®æ ‡®ù‡©Ç‡®† ‡®¨‡©ã‡®≤‡®£‡®æ", meaning:"‡®∏‡®æ‡®´‡®º-‡®∏‡®æ‡®´‡®º ‡®ù‡©Ç‡®† ‡®¨‡©ã‡®≤‡®£‡®æ" },
  { idiom:"‡®¨‡®æ‡®Ç‡®π ‡®´‡©ú‡®®‡®æ", meaning:"‡®∏‡®π‡®æ‡®∞‡®æ ‡®¶‡©á‡®£‡®æ / ‡®Æ‡®¶‡®¶ ‡®ï‡®∞‡®®‡©Ä" },
  { idiom:"‡®ñ‡©Ç‡®® ‡®™‡®∏‡©Ä‡®®‡®æ ‡®á‡©±‡®ï ‡®ï‡®∞‡®®‡®æ", meaning:"‡®¨‡®π‡©Å‡®§ ‡®Æ‡®ø‡®π‡®®‡®§ ‡®ï‡®∞‡®®‡©Ä" },
  { idiom:"‡®Ö‡©±‡®ó ‡®¨‡®ó‡©Ç‡®≤‡®æ ‡®π‡©ã‡®£‡®æ", meaning:"‡®¨‡®π‡©Å‡®§ ‡®ó‡©Å‡©±‡®∏‡©á ‡®µ‡®ø‡©±‡®ö ‡®Ü ‡®ú‡®æ‡®£‡®æ" },
  { idiom:"‡®Æ‡©Ç‡©∞‡®π ‡®≤‡©Å‡®ï‡®æ‡®â‡®£‡®æ", meaning:"‡®∂‡®∞‡®Æ‡®ø‡©∞‡®¶‡®æ ‡®π‡©ã ‡®ú‡®æ‡®£‡®æ / ‡®∏‡®æ‡®π‡®Æ‡®£‡©á ‡®®‡®æ ‡®Ü ‡®∏‡®ï‡®£‡®æ" }
];

const L3 = [
  { idiom:"‡®Ö‡©±‡®ñ‡®æ‡®Ç ‡®µ‡®ø‡©±‡®ö ‡®ß‡©Ç‡©ú ‡®™‡®æ‡®â‡®£‡®æ", meaning:"‡®ß‡©ã‡®ñ‡®æ ‡®¶‡©á‡®£‡®æ" },
  { idiom:"‡®®‡©±‡®ï ‡®ï‡©±‡®ü‡®£‡®æ", meaning:"‡®á‡©±‡®ú‡®º‡®§ ‡®ò‡®ü‡®æ‡®â‡®£‡®æ" },
  { idiom:"‡®ï‡©∞‡®® ‡®ñ‡©ú‡©á ‡®π‡©ã‡®£‡®æ", meaning:"‡®∏‡®æ‡®µ‡®ß‡®æ‡®® ‡®π‡©ã ‡®ú‡®æ‡®£‡®æ" },
  { idiom:"‡®¶‡©∞‡®¶ ‡®ñ‡©±‡®ü‡©á ‡®ï‡®∞‡®®‡®æ", meaning:"‡®π‡®∞‡®æ ‡®¶‡©á‡®£‡®æ" },
  { idiom:"‡®π‡©±‡®• ‡®™‡©à‡®∞ ‡®´‡©Å‡©±‡®≤ ‡®ú‡®æ‡®£‡®æ", meaning:"‡®ò‡®¨‡®∞‡®æ ‡®ú‡®æ‡®£‡®æ" },
  { idiom:"‡®∞‡®æ‡®à ‡®¶‡®æ ‡®™‡®π‡®æ‡©ú ‡®¨‡®£‡®æ‡®â‡®£‡®æ", meaning:"‡®õ‡©ã‡®ü‡©Ä ‡®ó‡©±‡®≤ ‡®µ‡©±‡®°‡©Ä ‡®ï‡®∞‡®®‡©Ä" }
];

/* ===================== Game State ===================== */
let currentLevel = 0;
let score = 0;
let answered = false;
let currentMCQCorrectIndex = -1;

let L1Q = shuffle(L1);
let L2Q = shuffle(L2_PAIRS);
let L3Q = shuffle(L3);

/* ===================== Menu + Reset ===================== */
function goMenu(){
  currentLevel = 0;
  answered = false;
  el('lvlName').textContent="‚Äî";
  el('stage').innerHTML = `
    <div class="panel" style="background:#fff; box-shadow:none; padding:8px; margin:0">
      <div style="font-size:18px; margin:4px 0 10px">‡®ï‡©ã‡®à ‡®á‡©±‡®ï ‡®≤‡©à‡®µ‡®≤ ‡®ö‡©Å‡®£‡©ã üëá</div>
      <div class="btnrow">
        <button onclick="startLevel(1)">Level 1 (MCQ)</button>
        <button onclick="startLevel(2)">Level 2 (Drag & Drop)</button>
        <button onclick="startLevel(3)">Level 3 (Bubble)</button>
      </div>
      <div style="margin-top:10px; font-size:13px; opacity:.75">
        ‚úÖ iPhone sound ‡®≤‡®à ‡®™‡®π‡®ø‡®≤‡®æ‡®Ç ‚ÄúStart/Test‚Äù ‡®¶‡®¨‡®æ‡®ì‡•§
      </div>
    </div>
  `;
}
function resetAll(){
  playClick();
  score = 0;
  el('score').textContent = score;
  toast("Reset ‚úÖ");
  goMenu();
}

/* ===================== Level 1 (MCQ) ===================== */
let l1Index = 0;
function renderL1(){
  el('lvlName').textContent = "Level 1 (MCQ)";
  const q = L1Q[l1Index];

  const correctText = q.opts[q.ans];
  const shuffledOpts = shuffle(q.opts);
  currentMCQCorrectIndex = shuffledOpts.indexOf(correctText);

  const optsHTML = shuffledOpts.map((o,i)=>(
    `<div class="opt" data-i="${i}" onclick="pickMCQ(${i})">${o}</div>`
  )).join("");

  el('stage').innerHTML = `
    <div class="qtitle">Q${l1Index+1}. ${q.q}</div>
    <div class="hint">‡®Æ‡©Å‡®π‡®æ‡®µ‡®∞‡®æ: <b>${q.idiom}</b></div>
    <div class="grid2">${optsHTML}</div>
    <div class="btnrow" style="margin-top:12px">
      <button onclick="nextL1()">‡®Ö‡®ó‡®≤‡®æ ‚û°Ô∏è</button>
    </div>
  `;
  answered=false;
}
function pickMCQ(i){
  playClick();
  if(answered) return;
  answered = true;

  const nodes = Array.from(document.querySelectorAll(".opt"));
  nodes.forEach((n)=>{
    const oi = Number(n.dataset.i);
    if(oi===currentMCQCorrectIndex) n.classList.add("good");
    if(oi===i && oi!==currentMCQCorrectIndex) n.classList.add("bad");
  });

  if(i===currentMCQCorrectIndex){
    score += 10; playCorrect(); toast("‡®∏‡®π‡©Ä ‚úÖ +10");
  }else{
    playWrong(); toast("‡®ó‡®≤‡®§ ‚ùå");
  }
  el('score').textContent = score;
}
function nextL1(){
  playClick();
  l1Index++;
  if(l1Index>=L1Q.length){
    playWin();
    el('stage').innerHTML = `
      <div class="qtitle">üéâ Level 1 Completed!</div>
      <div style="font-size:18px;margin:10px 0">‡®∏‡®ï‡©ã‡®∞: <b>${score}</b></div>
      <div class="btnrow">
        <button onclick="startLevel(2)">‡®π‡©Å‡®£ Level 2 ‚û°Ô∏è</button>
        <button class="secondary" onclick="goMenu()">Menu</button>
      </div>`;
    return;
  }
  renderL1();
}

/* ===================== Level 2 (Drag & Drop) ===================== */
let ddState = []; // {meaning, correct, done}
function renderL2(){
  el('lvlName').textContent = "Level 2 (Drag & Drop)";
  L2Q = shuffle(L2_PAIRS);

  const idioms = shuffle(L2Q.map(p=>p.idiom));
  ddState = L2Q.map(p=>({ meaning:p.meaning, correct:p.idiom, done:false }));

  const left = idioms.map((id)=>`
    <div class="pill" data-idiom="${escapeHtml(id)}">üß© ${id}</div>
  `).join("");

  const right = ddState.map((s,slot)=>`
    <div class="drop" data-slot="${slot}">
      <div style="min-width:22px">üéØ</div>
      <div>
        <div><strong>‡®Ö‡®∞‡®•:</strong> ${s.meaning}</div>
        <div class="mini">‡®á‡®•‡©á ‡®∏‡®π‡©Ä ‡®Æ‡©Å‡®π‡®æ‡®µ‡®∞‡®æ ‡®õ‡©±‡®°‡©ã ‚úÖ</div>
      </div>
    </div>
  `).join("");

  el('stage').innerHTML = `
    <div class="qtitle">Level 2 ‚Äî Drag & Drop (Correct pair vanish ‚úÖ)</div>
    <div class="hint">‡®∏‡®π‡©Ä ‡®°‡®∞‡©å‡®™ ‡®ï‡®∞‡®¶‡©á ‡®π‡©Ä ‡®Æ‡©Å‡®π‡®æ‡®µ‡®∞‡®æ ‡®Ö‡®§‡©á ‡®Ö‡®∞‡®• ‡®µ‡®æ‡®≤‡®æ ‡®¨‡®æ‡®ï‡®∏ ‡®¶‡©ã‡®µ‡©á‡®Ç ‡®ó‡®æ‡®á‡®¨ ‡®π‡©ã ‡®ú‡®æ‡®£‡®ó‡©á ‚úÖ</div>

    <div class="dd-wrap">
      <div class="dd-col">
        <div class="dd-title">üß© ‡®Æ‡©Å‡®π‡®æ‡®µ‡®∞‡©á</div>
        <div id="idiomPile">${left}</div>
      </div>

      <div class="dd-col">
        <div class="dd-title">üéØ ‡®Ö‡®∞‡®•</div>
        <div id="dropZone">${right}</div>
        <div class="btnrow" style="margin-top:10px">
          <button class="ghost" onclick="startLevel(2)">Shuffle/Restart</button>
          <button class="secondary" onclick="goMenu()">Menu</button>
        </div>
      </div>
    </div>
  `;

  initMobileDragDrop(); // iPhone safe
}

function initMobileDragDrop(){
  const pills = Array.from(document.querySelectorAll(".pill"));
  let active = null; // {el,startX,startY}

  function onMove(e){
    if(!active) return;
    const dx = e.clientX - active.startX;
    const dy = e.clientY - active.startY;
    active.el.style.transform = `translate(${dx}px, ${dy}px)`;
    e.preventDefault();
  }

  function resetPill(p){
    p.style.transform = "";
    p.style.zIndex = "";
  }

  function markDoneIfAll(){
    const remainingDrops = document.querySelectorAll(".drop:not(.correctPair)").length;
    if(remainingDrops===0){
      playWin();
      toast("Level 2 Completed üèÜ");
      el('stage').insertAdjacentHTML("beforeend", `
        <div class="panel" style="margin-top:12px;background:#fff;box-shadow:none">
          <div class="qtitle">üéâ Level 2 Completed!</div>
          <div style="font-size:18px;margin:10px 0">‡®∏‡®ï‡©ã‡®∞: <b>${score}</b></div>
          <div class="btnrow">
            <button onclick="startLevel(3)">‡®π‡©Å‡®£ Level 3 ‚û°Ô∏è</button>
            <button class="secondary" onclick="goMenu()">Menu</button>
          </div>
        </div>
      `);
    }
  }

  function onUp(e){
    if(!active) return;

    const pill = active.el;

    // iPhone hit-test: hide for a moment
    pill.style.visibility = "hidden";
    const target = document.elementFromPoint(e.clientX, e.clientY);
    pill.style.visibility = "visible";

    const drop = target ? target.closest(".drop") : null;

    if(drop){
      const slot = Number(drop.dataset.slot);
      if(ddState[slot].done){
        resetPill(pill);
        active = null;
        window.removeEventListener("pointermove", onMove, {passive:false});
        window.removeEventListener("pointerup", onUp, {passive:false});
        window.removeEventListener("pointercancel", onUp, {passive:false});
        return;
      }

      const idiom = pill.getAttribute("data-idiom");

      // Check correctness instantly
      if(idiom === ddState[slot].correct){
        ddState[slot].done = true;
        score += 10;
        el('score').textContent = score;

        playCorrect();
        toast("+10 ‚úÖ ‡®∏‡®π‡©Ä");

        // vanish: pill + meaning box
        pill.style.display = "none";
        drop.classList.add("flashOk");
        setTimeout(()=>{
          drop.classList.add("correctPair");
          markDoneIfAll();
        }, 280);

      }else{
        playWrong();
        toast("‡®ó‡®≤‡®§ ‚ùå");
        drop.classList.add("flashBad");
        setTimeout(()=>drop.classList.remove("flashBad"), 260);
        resetPill(pill);
      }
    }else{
      playWrong();
      toast("‡®á‡®•‡©á ‡®®‡®π‡©Ä‡®Ç ‚ùå");
      resetPill(pill);
    }

    active = null;
    window.removeEventListener("pointermove", onMove, {passive:false});
    window.removeEventListener("pointerup", onUp, {passive:false});
    window.removeEventListener("pointercancel", onUp, {passive:false});
    e.preventDefault();
  }

  pills.forEach(pill=>{
    pill.addEventListener("pointerdown",(e)=>{
      active = { el: pill, startX: e.clientX, startY: e.clientY };
      pill.style.zIndex = 9999;
      playClick();
      window.addEventListener("pointermove", onMove, {passive:false});
      window.addEventListener("pointerup", onUp, {passive:false});
      window.addEventListener("pointercancel", onUp, {passive:false});
      e.preventDefault();
    }, {passive:false});
  });
}

/* ===================== Level 3 Bubble (same as before, short set) ===================== */
let bubbleIndex = 0;
let bubbleRunning = false;
let bubbleTimer = null;
let timeLeft = 45;
let bubbleObjs = [];
let currentChoices = [];
let rafId = null;

function startBubbleLevel(){
  bubbleIndex = 0;
  timeLeft = 45;
  bubbleRunning = true;
  bubbleObjs = [];
  currentChoices = [];

  el('lvlName').textContent = "Level 3 (Bubble)";

  el('stage').innerHTML = `
    <div class="qtitle">Level 3 ‚Äî Bubble</div>
    <div class="hint">‡®∏‡®π‡©Ä ‡®Ö‡®∞‡®• ‡®µ‡®æ‡®≤‡©Ä ‡®¨‡©Å‡®¨‡®≤ ‡®ü‡©à‡®™ ‡®ï‡®∞‡©ã ‚úÖ</div>

    <div class="bubbleWrap">
      <div class="bubbleHeader">
        <div class="target">
          üéØ ‡®ü‡®æ‡®∞‡®ó‡©á‡®ü ‡®Æ‡©Å‡®π‡®æ‡®µ‡®∞‡®æ: <b id="targetIdiom">‚Äî</b><br/>
          <span style="font-size:13px;opacity:.75">‡®∏‡®π‡©Ä ‡®Ö‡®∞‡®• ‡®µ‡®æ‡®≤‡©Ä ‡®¨‡©Å‡®¨‡®≤ ‡®ü‡©à‡®™ ‡®ï‡®∞‡©ã ‚úÖ</span>
        </div>
        <div class="timerBox">
          ‚è±Ô∏è Time: <b id="timeLeft">45</b>s<br/>
          ‚úÖ Done: <b id="doneCount">0</b>/${L3Q.length}
        </div>
      </div>

      <div class="playfield" id="playfield"></div>
    </div>

    <div class="btnrow" style="margin-top:12px">
      <button onclick="restartBubble()">Restart</button>
      <button class="secondary" onclick="goMenu()">Menu</button>
    </div>
  `;

  setBubbleTarget();
  startBubbleTimer();
  render4Bubbles();
  rafId = requestAnimationFrame(moveLoop);
}

function setBubbleTarget(){
  el("targetIdiom").textContent = L3Q[bubbleIndex].idiom;
  el("doneCount").textContent = bubbleIndex;
}
function startBubbleTimer(){
  clearInterval(bubbleTimer);
  el("timeLeft").textContent = timeLeft;
  bubbleTimer = setInterval(()=>{
    if(!bubbleRunning) return;
    timeLeft--;
    el("timeLeft").textContent = timeLeft;
    if(timeLeft<=0) endBubble(true,false);
  }, 1000);
}
function pickChoices4(){
  const correct = L3Q[bubbleIndex].meaning;
  const allMeanings = L3.map(x=>x.meaning);
  const wrongPool = shuffle(allMeanings.filter(m=>m!==correct));
  currentChoices = shuffle([correct, wrongPool[0], wrongPool[1], wrongPool[2] || wrongPool[0]]);
}
function colorFor(i){
  const base = 190 + i*18;
  return `radial-gradient(circle at 30% 30%, hsla(${base},85%,92%,1), hsla(${base+12},90%,66%,.96))`;
}
function nonOverlappingStartPositions(pf, size){
  const W = pf.clientWidth, H = pf.clientHeight;
  const margin = 10;
  const spots = [];
  let tries = 0;

  while(spots.length < 4 && tries < 900){
    tries++;
    const x = rand(margin, Math.max(margin, W - size - margin));
    const y = rand(margin, Math.max(margin, H - size - margin));
    let ok = true;
    for(const s of spots){
      const dx = (x - s.x), dy = (y - s.y);
      if(Math.hypot(dx,dy) < size*0.90) { ok = false; break; }
    }
    if(ok) spots.push({x,y});
  }
  while(spots.length < 4){
    spots.push({x: margin + (spots.length%2)*(size+14), y: margin + Math.floor(spots.length/2)*(size+14)});
  }
  return spots;
}
function render4Bubbles(){
  if(!bubbleRunning) return;
  const pf = el("playfield");
  if(!pf) return;

  pf.innerHTML = "";
  bubbleObjs = [];

  pickChoices4();
  const size = 160;
  const starts = nonOverlappingStartPositions(pf, size);

  currentChoices.forEach((text,i)=>{
    const b = document.createElement("div");
    b.className = "bubble";
    b.textContent = text;
    b.style.background = colorFor(i);

    const x = starts[i].x, y = starts[i].y;
    b.style.left = x + "px";
    b.style.top  = y + "px";

    const vx = rand(-1.6, 1.6);
    const vy = rand(-1.6, 1.6);

    b.onclick = ()=>bubblePick(b, text);

    pf.appendChild(b);
    bubbleObjs.push({ el:b, x, y, vx, vy, text, size });
  });
}
function bubblePick(node, text){
  if(!bubbleRunning) return;

  playPop();
  node.classList.add("pop");

  const correct = L3Q[bubbleIndex].meaning;

  if(text === correct){
    score += 10;
    playCorrect();
    toast("‡®∏‡®π‡©Ä ‚úÖ +10");
    el('score').textContent = score;

    setTimeout(()=>{
      bubbleIndex++;
      if(bubbleIndex >= L3Q.length){
        endBubble(false,true);
        return;
      }
      setBubbleTarget();
      render4Bubbles();
    }, 220);

  }else{
    playWrong();
    toast("‡®ó‡®≤‡®§ ‚ùå");
    setTimeout(()=>{
      node.classList.remove("pop");
      render4Bubbles();
    }, 220);
  }
}
function moveLoop(){
  if(!bubbleRunning) return;
  const pf = el("playfield");
  if(!pf) return;

  const W = pf.clientWidth;
  const H = pf.clientHeight;

  for(const o of bubbleObjs){
    o.x += o.vx;
    o.y += o.vy;

    if(o.x <= 0 || o.x >= W - o.size){
      o.vx *= -1;
      o.x = clamp(o.x, 0, W - o.size);
    }
    if(o.y <= 0 || o.y >= H - o.size){
      o.vy *= -1;
      o.y = clamp(o.y, 0, H - o.size);
    }

    o.el.style.left = o.x + "px";
    o.el.style.top  = o.y + "px";
  }
  rafId = requestAnimationFrame(moveLoop);
}
function stopBubbleLoop(){
  bubbleRunning = false;
  clearInterval(bubbleTimer);
  if(rafId) cancelAnimationFrame(rafId);
  rafId = null;
}
function restartBubble(){
  playClick();
  stopBubbleLoop();
  startLevel(3);
}
function endBubble(timeout=false, completed=false){
  stopBubbleLoop();
  if(completed){ playWin(); toast("Completed üèÜ"); }
  else if(timeout){ playWrong(); toast("Time Up ‚è±Ô∏è"); }

  el('stage').innerHTML = `
    <div class="qtitle">${completed ? "üèÜ Level 3 Completed!" : (timeout ? "‚è±Ô∏è Time Up!" : "‚úÖ Level 3 Ended")}</div>
    <div style="font-size:18px;margin:10px 0">Score: <b>${score}</b></div>
    <div class="btnrow">
      <button onclick="startLevel(3)">Play Again</button>
      <button class="secondary" onclick="goMenu()">Menu</button>
    </div>
  `;
}

/* ===================== Level switch ===================== */
function startLevel(lvl){
  playClick();
  stopBubbleLoop();

  currentLevel = lvl;

  if(lvl===1){
    L1Q = shuffle(L1);
    l1Index = 0;
    renderL1();
  }else if(lvl===2){
    renderL2();
  }else if(lvl===3){
    L3Q = shuffle(L3);
    startBubbleLevel();
  }
}

/* ===================== Start ===================== */
goMenu();
</script>
</body>
</html>
